---
- hosts: webservers
  become: yes
  become_user: root
  user: vagrant

  vars:
    APACHE_LOG_DIR: "/vagrant/log"
    # environment:
    #   https_proxy: "{{ lookup('env', 'https_proxy') }}"

  tasks:
    - name: Only run "update_cache=yes" if the last one is more than 3600 seconds ago
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: uninstall nginx
      apt: name=nginx state=absent

    - name: install apache
      apt: name=apache2 state=present 
    
    - name: install apache2 depends packages
      apt: name="{{ item }}" state=present 
      with_items:
       - apache2-utils
       - libexpat1
       - ssl-cert

    - name: install libapache2-mod-wsgi
      apt: name=libapache2-mod-wsgi state=present 

    - name: copy wsgi conf
      copy: src=/vagrant/conf/wsgi.conf dest=/etc/apache2/mods-enabled/wsgi.conf
      notify: restart apache

    - apache2_module: name=wsgi state=present
      notify: restart apache
         
  handlers:
    - name: restart apache
      service: name=apache2 state=restarted

- import_playbook: ./pythonenv.yml
